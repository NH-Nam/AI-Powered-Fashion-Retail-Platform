<!DOCTYPE html>
<html>

<head>
    <base href="/public">
    <%- include('css') %>
    <% index1=index2=index3=index4=index5=0; %>
    <style>
        .title {
            margin-bottom: 5vh;
        }

        .card {
            max-width: 100%;
            width: 90%;
            box-shadow: 0 6px 20px 0 rgba(0, 0, 0, 0.3);
            border-radius: 1rem;
            border: transparent;
            margin-bottom: 50px;
            margin-left: auto;
            margin-right: auto;
        }

        @media(max-width:767px) {
            .card {
                margin: 3vh auto;
            }
        }

        .cart {
            background-color: #fff;
            padding: 4vh 5vh;
            border-bottom-left-radius: 1rem;
            border-top-left-radius: 1rem;
        }

        @media(max-width:767px) {
            .cart {
                padding: 4vh;
                border-bottom-left-radius: unset;
                border-top-right-radius: 1rem;
            }
        }

        .row {
            margin: 0;
        }

        .title b {
            font-size: 1.5rem;
        }

        .main {
            margin: 0;
            padding: 2vh 0;
            width: 100%;
        }

        .col-2,
        .col {
            padding: 0 1vh;
        }


        .back-to-shop {
            margin-top: 4.5rem;
        }


        select {
            border: 1px solid rgba(0, 0, 0, 0.137);
            padding: 1.5vh 1vh;
            margin-bottom: 4vh;
            outline: none;
            width: 100%;
            background-color: rgb(247, 247, 247);
        }

        input {
            border: 1px solid rgba(0, 0, 0, 0.137);
            padding: 1vh;
            margin-bottom: 4vh;
            outline: none;
            width: 100%;
            background-color: rgb(247, 247, 247);
        }

        a {
            color: black;
        }

        a:hover {
            color: blue;
            text-decoration: none;
        }

        .navtab {
            min-width: 10rem;
        }

        .nav-pills .navtab {
            margin: 0 2rem;
        }

        thead tr th {
            background-color: skyblue;
        }

        .navOrder{
            margin: auto;
        }
        /* Orders accordion layout */
        .order-accordion .accordion-item { margin-bottom: 12px; border-radius: 8px; overflow: hidden; }
        .order-accordion .accordion-button { background: #efefef; font-weight: 600; }
        .order-accordion .accordion-button:not(.collapsed) { box-shadow: none; }
        .order-accordion .order-actions { white-space: nowrap; }
        .order-accordion .btn-cancel-all { padding: .35rem .75rem; }
        
        /* Ensure consistent accordion button widths */
        .order-accordion .accordion-header { width: 100%; }
        .order-accordion .accordion-button { width: 100%; text-align: center; }
        .order-accordion .accordion-item { width: 100%; }
        
        /* Center the order text content */
        .order-accordion .accordion-button {
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        
        /* Standardize order display format */
        .order-accordion .order-info { 
            display: flex; 
            align-items: center; 
            width: 100%; 
            gap: 10px; 
        }
        
        /* Ensure all tabs have consistent spacing */
        .tab-pane { padding: 20px 0; }
        .order-accordion { width: 100%; }
    </style>     
</head>

<body>
    <div class="hero_area">
        <%- include('header') %>
        <div class="card">
            <div class="row">
                <div class="col-md-12 cart">
                    <div class="title">
                        <div class="row">
                            <div class="col">
                                <h4><b>My Orders</b></h4>
                            </div>
                            <div class="col align-self-center text-right text-muted"><strong><%= orders.length%> Orders</strong></div>
                        </div>
                    </div>
                    <% if (message) { %>
                        <div class="alert alert-<%= message.type %>">
                            <button type="button" class="close" data-dismiss="alert" aria-hidden="true">x</button>
                            <%= message.content %>
                        </div>
                    <% } %>
                    <div class="navbar navbar-expand-lg custom_nav-container ">
                        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                            <span class=""></span>
                        </button>
                        <div class="collapse navbar-collapse" id="navbarNav">
                            <ul class="navbar-nav nav nav-pills mb-3 navOrder" id="pills-tab" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active navtab" id="pills-all-tab" data-bs-toggle="pill"
                                        data-bs-target="#pills-all" type="button" role="tab" aria-controls="pills-all"
                                        aria-selected="true">All</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link navtab" id="pills-wait-tab" data-bs-toggle="pill"
                                        data-bs-target="#pills-wait" type="button" role="tab" aria-controls="pills-wait"
                                        aria-selected="false">Pending</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link navtab" id="pills-process-tab" data-bs-toggle="pill"
                                        data-bs-target="#pills-process" type="button" role="tab"
                                        aria-controls="pills-process" aria-selected="false">Processing</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link navtab" id="pills-complete-tab" data-bs-toggle="pill"
                                        data-bs-target="#pills-complete" type="button" role="tab"
                                        aria-controls="pills-complete" aria-selected="false">Complete</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link navtab" id="pills-cancel-tab" data-bs-toggle="pill"
                                        data-bs-target="#pills-cancel" type="button" role="tab"
                                        aria-controls="pills-cancel" aria-selected="false">Cancelled</button>
                                </li>
                            </ul>
                        </div>
                    </div>


                    <div class="tab-content" id="pills-tabContent">
                        <div class="tab-pane fade show active" id="pills-all" role="tabpanel"
                            aria-labelledby="pills-all-tab" tabindex="0">
                            <div class="accordion order-accordion" id="ordersAccordion">
                                <% let seen = new Set(); let groupCount = 0; let idx = 0; %>
                                <% for (let g of orders) { if (!seen.has(String(g.order_id._id))) { seen.add(String(g.order_id._id)); groupCount++; %>
                                <div class="accordion-item">
                                  <h2 class="accordion-header" id="heading-<%= idx %>">
                                    <div class="d-flex align-items-center justify-content-between w-100 p-0">
                                      <button class="accordion-button collapsed flex-grow-1" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-<%= idx %>" aria-expanded="false" aria-controls="collapse-<%= idx %>">
                                        Order: <span class="order-id-copy" data-order-id="<%= g.order_id.order_code || g.order_id._id %>" style="cursor: pointer; text-decoration: underline; color: #007bff;"><%= g.order_id.order_code || g.order_id._id %></span> • <%= g.order_id.payment_status %> • <%= g.order_id.delivery_status %>
                                      </button>
                                    </div>
                                  </h2>
                                  <div id="collapse-<%= idx %>" class="accordion-collapse collapse" aria-labelledby="heading-<%= idx %>" data-bs-parent="#ordersAccordion">
                                    <div class="accordion-body">
                                      <table class="table table-striped table-borderless align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Title</th>
                                            <th>Image</th>
                                            <th>Quantity</th>
                                            <th>Price</th>
                                            <th>
                                              <div class="d-flex align-items-center justify-content-between w-100">
                                                <span>Action</span>
                                                <% if (g.order_id.delivery_status === 'Cancelled') { %>
                                                  <a href="/delete_all_orders/<%= g.order_id._id %>" class="btn btn-danger btn-sm float-end" onclick="return showDeleteOrderAlert('<%= g.order_id._id %>')"><i class="bi bi-x-octagon"></i> Delete Order</a>
                                                <% } %>
                                              </div>
                                            </th>
                                        </tr>
                                    </thead>
                                        <tbody>
                                          <% for (let it of orders) { if (String(it.order_id._id) === String(g.order_id._id)) { %>
                                            <tr class="table-warning">
                                              <td><%= it.product_id.title %></td>
                                              <td><img src="<%= it.product_id.image %>" alt="orders" style="width: 3.5rem;"></td>
                                              <td><%= it.num %></td>
                                              <td><%= numberFormat(it.price) %></td>
                                              <td class="text-end">
                                                <% if (it.order_id.delivery_status === 'Cancelled') { %>
                                                  <a href="/delete_orders/<%= it._id %>" class="btn btn-danger" onclick="return showDeleteAlert('<%= it._id %>')"><i class="bi bi-trash"></i> Delete</a>
                                                <% } else { %>
                                                  <a href="/delete_orders/<%= it._id %>" class="btn btn-danger" onclick="return showDeleteAlert('<%= it._id %>')"><i class="bi bi-trash"></i> Delete</a>
                                                <% } %>
                                          </td>
                                        </tr>
                                          <% } } %>
                                    </tbody>
                                </table>
                                    </div>
                                  </div>
                                </div>
                                <% idx++; } } %>
                            </div>
                            <% if (groupCount === 0) { %>
                                    <p style="text-align:center;">There are no orders!</p>
                            <% } %>
                            </div>

                        <div class="tab-pane fade" id="pills-wait" role="tabpanel" aria-labelledby="pills-wait-tab" tabindex="0">
                            <div class="accordion order-accordion" id="pendingAccordion">
                              <% let seenP = new Set(); let pCount = 0; let pIdx = 0; %>
                              <% for (let w of orders) { if (w.order_id.payment_status == 'Cash' && w.order_id.delivery_status == 'processing' && !seenP.has(String(w.order_id._id))) { seenP.add(String(w.order_id._id)); pCount++; %>
                                <div class="accordion-item">
                                  <h2 class="accordion-header" id="p-head-<%= pIdx %>">
                                    <div class="d-flex align-items-center justify-content-between w-100">
                                      <button class="accordion-button collapsed flex-grow-1" type="button" data-bs-toggle="collapse" data-bs-target="#p-col-<%= pIdx %>" aria-expanded="false" aria-controls="p-col-<%= pIdx %>">
                                        Order: <span class="order-id-copy" data-order-id="<%= w.order_id.order_code || w.order_id._id %>" style="cursor: pointer; text-decoration: underline; color: #007bff;"><%= w.order_id.order_code || w.order_id._id %></span> • <%= w.order_id.payment_status %> • <%= w.order_id.delivery_status %>
                                      </button>
                                      
                        </div>
                                  </h2>
                                  <div id="p-col-<%= pIdx %>" class="accordion-collapse collapse" aria-labelledby="p-head-<%= pIdx %>" data-bs-parent="#pendingAccordion">
                                    <div class="accordion-body">
                                      <table class="table table-striped table-borderless align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Title</th>
                                            <th>Image</th>
                                            <th>Quantity</th>
                                            <th>Price</th>
                                            <th>
                                              <div class="d-flex align-items-center justify-content-between w-100">
                                                <span>Action</span>
                                                 
                                              </div>
                                            </th>
                                        </tr>
                                    </thead>
                                        <tbody>
                                          <% for (let wi of orders) { if (String(wi.order_id._id) === String(w.order_id._id)) { %>
                                        <tr class="table-warning">
                                              <td><%= wi.product_id.title %></td>
                                              <td><img src="<%= wi.product_id.image %>" style="width:3.5rem;"></td>
                                              <td><%= wi.num %></td>
                                              <td><%= numberFormat(wi.price) %></td>
                                              <td></td>
                                        </tr>
                                          <% } } %>
                                    </tbody>
                                </table>
                                    </div>
                                  </div>
                                </div>
                              <% pIdx++; } } %>
                            </div>
                            <% if (pCount === 0) { %><p style="text-align:center;">There are no orders!</p><% } %>
                            </div>

                        <div class="tab-pane fade" id="pills-process" role="tabpanel" aria-labelledby="pills-process-tab" tabindex="0">
                            <div class="accordion order-accordion" id="processingAccordion">
                              <% let seenR = new Set(); let rCount = 0; let rIdx = 0; %>
                              <% for (let pr of orders) { if (pr.order_id.delivery_status == 'processing' && !seenR.has(String(pr.order_id._id))) { seenR.add(String(pr.order_id._id)); rCount++; %>
                                <div class="accordion-item">
                                  <h2 class="accordion-header" id="r-head-<%= rIdx %>">
                                    <div class="d-flex align-items-center justify-content-between w-100">
                                      <button class="accordion-button collapsed flex-grow-1" type="button" data-bs-toggle="collapse" data-bs-target="#r-col-<%= rIdx %>" aria-expanded="false" aria-controls="r-col-<%= rIdx %>">
                                        Order: <span class="order-id-copy" data-order-id="<%= pr.order_id.order_code || pr.order_id._id %>" style="cursor: pointer; text-decoration: underline; color: #007bff;"><%= pr.order_id.order_code || pr.order_id._id %></span> • <%= pr.order_id.payment_status %> • <%= pr.order_id.delivery_status %>
                                      </button>
                        </div>
                                  </h2>
                                  <div id="r-col-<%= rIdx %>" class="accordion-collapse collapse" aria-labelledby="r-head-<%= rIdx %>" data-bs-parent="#processingAccordion">
                                    <div class="accordion-body">
                                      <table class="table table-striped table-borderless align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Title</th>
                                            <th>Image</th>
                                            <th>Quantity</th>
                                            <th>Price</th>
                                            <th>
                                              <div class="d-flex align-items-center justify-content-between w-100">
                                                <span>Action</span>
                                                 
                                              </div>
                                            </th>
                                        </tr>
                                    </thead>
                                        <tbody>
                                          <% for (let ri of orders) { if (String(ri.order_id._id) === String(pr.order_id._id)) { %>
                                        <tr class="table-warning">
                                              <td><%= ri.product_id.title %></td>
                                              <td><img src="<%= ri.product_id.image %>" style="width:3.5rem;"></td>
                                              <td><%= ri.num %></td>
                                              <td><%= numberFormat(ri.price) %></td>
                                              <td></td>
                                        </tr>
                                          <% } } %>
                                    </tbody>
                                </table>
                                    </div>
                                  </div>
                                </div>
                              <% rIdx++; } } %>
                            </div>
                            <% if (rCount === 0) { %><p style="text-align:center;">There are no orders!</p><% } %>
                            </div>

                        <div class="tab-pane fade" id="pills-complete" role="tabpanel" aria-labelledby="pills-complete-tab" tabindex="0">
                            <div class="accordion order-accordion" id="completeAccordion">
                              <% let seenC = new Set(); let cCount = 0; let cIdx = 0; %>
                              <% for (let co of orders) { if (co.order_id.delivery_status=='Delivered' && co.order_id.payment_status=='Paid' && !seenC.has(String(co.order_id._id))) { seenC.add(String(co.order_id._id)); cCount++; %>
                                <div class="accordion-item">
                                  <h2 class="accordion-header" id="c-head-<%= cIdx %>">
                                    <div class="d-flex align-items-center justify-content-between w-100">
                                      <button class="accordion-button collapsed flex-grow-1" type="button" data-bs-toggle="collapse" data-bs-target="#c-col-<%= cIdx %>" aria-expanded="false" aria-controls="c-col-<%= cIdx %>">
                                        Order: <span class="order-id-copy" data-order-id="<%= co.order_id.order_code || co.order_id._id %>" style="cursor: pointer; text-decoration: underline; color: #007bff;"><%= co.order_id.order_code || co.order_id._id %></span> • <%= co.order_id.payment_status %> • <%= co.order_id.delivery_status %>
                                      </button>
                        </div>
                                  </h2>
                                  <div id="c-col-<%= cIdx %>" class="accordion-collapse collapse" aria-labelledby="c-head-<%= cIdx %>" data-bs-parent="#completeAccordion">
                                    <div class="accordion-body">
                                      <table class="table table-striped table-borderless align-middle mb-0">
                                        <thead class="table-light"><tr><th>Title</th><th>Image</th><th>Quantity</th><th>Price</th><th>Action</th></tr></thead>
                                        <tbody>
                                          <% for (let ci of orders) { if (String(ci.order_id._id) === String(co.order_id._id)) { %>
                                        <tr class="table-warning">
                                              <td><%= ci.product_id.title %></td>
                                              <td><img src="<%= ci.product_id.image %>" style="width:3.5rem;"></td>
                                              <td><%= ci.num %></td>
                                              <td><%= numberFormat(ci.price) %></td>
                                              <td><a href="/delete_orders/<%= ci._id %>" class="btn btn-danger" onclick="return showDeleteAlert('<%= ci._id %>')"><i class="bi bi-trash"></i> Delete</a></td>
                                        </tr>
                                          <% } } %>
                                    </tbody>
                                </table>
                                    </div>
                                  </div>
                                </div>
                              <% cIdx++; } } %>
                            </div>
                            <% if (cCount === 0) { %><p style="text-align:center;">There are no orders!</p><% } %>
                            </div>

                        <div class="tab-pane fade" id="pills-cancel" role="tabpanel" aria-labelledby="pills-cancel-tab" tabindex="0">
                            <div class="accordion order-accordion" id="cancelledAccordion">
                              <% let seenX = new Set(); let xCount = 0; let xIdx = 0; %>
                              <% for (let ca of orders) { if (ca.order_id.delivery_status == 'Cancelled' && !seenX.has(String(ca.order_id._id))) { seenX.add(String(ca.order_id._id)); xCount++; %>
                                <div class="accordion-item">
                                  <h2 class="accordion-header" id="x-head-<%= xIdx %>">
                                    <div class="d-flex align-items-center justify-content-between w-100">
                                      <button class="accordion-button collapsed flex-grow-1" type="button" data-bs-toggle="collapse" data-bs-target="#x-col-<%= xIdx %>" aria-expanded="false" aria-controls="x-col-<%= xIdx %>">
                                        Order: <span class="order-id-copy" data-order-id="<%= ca.order_id.order_code || ca.order_id._id %>" style="cursor: pointer; text-decoration: underline; color: #007bff;"><%= ca.order_id.order_code || ca.order_id._id %></span> • <%= ca.order_id.payment_status %> • <%= ca.order_id.delivery_status %>
                                      </button>
                        </div>
                                  </h2>
                                  <div id="x-col-<%= xIdx %>" class="accordion-collapse collapse" aria-labelledby="x-head-<%= xIdx %>" data-bs-parent="#cancelledAccordion">
                                    <div class="accordion-body">
                                      <table class="table table-striped table-borderless align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Title</th>
                                            <th>Image</th>
                                            <th>Quantity</th>
                                            <th>Price</th>
                                            <th>
                                              <div class="d-flex align-items-center justify-content-between w-100">
                                                <span>Action</span>
                                                <a href="/delete_all_orders/<%= ca.order_id._id %>" class="btn btn-danger btn-sm float-end" onclick="return showDeleteOrderAlert('<%= ca.order_id._id %>')"><i class="bi bi-x-octagon"></i> Delete Order</a>
                                              </div>
                                            </th>
                                        </tr>
                                    </thead>
                                        <tbody>
                                          <% for (let xi of orders) { if (String(xi.order_id._id) === String(ca.order_id._id)) { %>
                                        <tr class="table-warning">
                                              <td><%= xi.product_id.title %></td>
                                              <td><img src="<%= xi.product_id.image %>" style="width:3.5rem;"></td>
                                              <td><%= xi.num %></td>
                                              <td><%= numberFormat(xi.price) %></td>
                                              <td><a href="/delete_orders/<%= xi._id %>" class="btn btn-danger" onclick="return showDeleteAlert('<%= xi._id %>')"><i class="bi bi-trash"></i> Delete</a></td>
                                        </tr>
                                          <% } } %>
                                    </tbody>
                                </table>
                                    </div>
                                  </div>
                                </div>
                              <% xIdx++; } } %>
                            </div>
                            <% if (xCount === 0) { %><p style="text-align:center;">There are no orders!</p><% } %>
                        </div>
                    </div>

                    <div class="back-to-shop"><a href="/">&leftarrow; Back to shop</a></div>
                </div>
            </div>
        </div>
    </div>


    <!-- end client section -->
    <!-- comment section -->

    <!-- end comment section -->
    <!-- footer start -->
    <%- include('footer') %>
        <!-- footer end -->
        
</body>
<script>
    // User cancellation disabled; contact support if needed.

    
    // Update notification messages for clarity
    function showDeleteAlert(orderDetailId) {
        Swal.fire({
            title: 'Are you sure you want to remove this product from your order?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, remove it!',
            cancelButtonText: 'No, keep it'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = "/delete_orders/" + orderDetailId;
            }
        });
        return false;
    }

    function showDeleteOrderAlert(orderId) {
        Swal.fire({
            title: 'Are you sure you want to delete this entire order?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'No, keep it'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = "/delete_all_orders/" + orderId;
            }
        });
        return false;
    }

    // Copy order ID to clipboard
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('order-id-copy')) {
            const orderId = e.target.getAttribute('data-order-id');
            navigator.clipboard.writeText(orderId).then(function() {
                // Show success feedback
                e.target.style.color = '#28a745';
                setTimeout(() => {
                    e.target.style.color = '#007bff';
                }, 1000);
            }).catch(function() {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = orderId;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                e.target.style.color = '#28a745';
                setTimeout(() => {
                    e.target.style.color = '#007bff';
                }, 1000);
            });
        }
    });
</script>
</html>