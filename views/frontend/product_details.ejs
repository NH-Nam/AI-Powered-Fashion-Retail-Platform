<!DOCTYPE html>
<html>
<head>
   <base href="/public">
   <%- include('css') %>
   <script src="dist/sweetalert.min.js"></script>
<link rel="stylesheet" type="text/css" href="dist/sweetalert.css">
   <style>
      .evaluate{
         margin-left: 20px; 
         border-left: solid #dad7d7 1px; 
         font-size: 13pt; 
         padding-top: 3px; 
         padding-left: 20px;
      }
      .btnAdd{
         margin-top: 20px; 
         width: 100%; 
         font-size: 30px;
      }
      /* Shopee-like variant chips */
      .variant-group { margin: 12px 0 4px 0; }
      .variant-label { font-weight: 600; margin-bottom: 6px; display: block; }
      .variant-chips { display: flex; flex-wrap: wrap; gap: 8px; }
      .variant-chip {
         padding: 8px 12px;
         border: 1px solid #e0dede;
         border-radius: 4px;
         background: #fff;
         cursor: pointer;
         user-select: none;
      }
      .variant-chip.selected {
         border-color: #ff5722;
         color: #ff5722;
         font-weight: 600;
         background: #fff7f3;
      }
      .variant-chip.disabled {
         opacity: 0.5;
         cursor: not-allowed;
      }
      .card-inner {
        margin-left: 4rem;
      }

      .img-account-profile {
        height: 10rem;
        border: 1px solid #000;
        border-radius: 50%;
        height: 150px;
        width: 150px;
      }
      @media(max-width:380px) {
         .fillComment {
            height: 10px;
            width: 70vw;
         }

         .allComment {
            padding-left: 20%;
            font-size: 20px;
         }
         .evaluate{
            margin-left: 5px;
            font-size: 9pt;
            padding-left: 6px;
         }
         .bi-star-fill, .fa-star{
            height: 12px;
            width: 12px;
         }
         .btnAdd{
            font-size:20px;
         }
         .img-account-profile{
            height: 100px;
            width: 100px;
         }
         p strong{
            font-size: 15px;
         }
         .card-inner {
            margin-left: 2rem;
         }
      }
   </style>
</head>

<body>
   <div class="hero_area">
    <%- include('header') %>

      <section class="product_section layout_padding">
         <div class="container">
            <div class="row">
               <div class="col-md-6 text-center">
                  <div class="border rounded-4 mb-3 d-flex justify-content-center">
                       <img style="max-width: 100%; max-height: 60vh; margin: auto;" class="rounded-4 fit" src="<%= product.image %>" />
                   </div>
               </div>
               <div class="col-md-6">
                  <h3><%= product.title %></h3>
                  <!-- show 5 stars -->
                  <ul style="display: flex; list-style-type: none; margin: 0px; padding: 0px;">
                     <li style="color: orange; font-size: 13pt; padding-top: 2px; margin-right: 5px;" class="evaluate">5.0</li>
                     <% for(let i = 0; i <5 ; i++) { %>
                     <li style="color: orange; padding: 2px;">
                              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                 class="bi bi-star-fill" viewBox="0 0 16 16">
                                 <path
                                    d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z">
                                 </path>
                              </svg>
                    </li>
                     <% } %>

                     <li class="evaluate">
                        <%= replies.length+comments.length%> Evaluate
                     </li>
                     <li class="evaluate">
                        <%= orders.length%> Sold
                     </li>
                  </ul>
                  <p style="color: red; font-size: 30px; margin-top: 15px; margin-bottom: 15px;">
                   <%= (product.discount_price > 0) ? numberFormat(product.discount_price) : numberFormat(product.price) %> VND</p>
                  <p
                     style="color: grey; font-size: 15px; margin-top: 15px; margin-bottom: 15px; text-decoration: line-through;">
                     <del><%= numberFormat(product.price) %> VND</del>
                  </p>

                  <!-- Fashion Attributes Section -->
                  <div class="fashion-attributes" style="margin: 20px 0; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
                     <h5 style="margin-bottom: 15px; color: #333;">Product Details</h5>
                     <div class="row">
                        <% if(product.brand) { %>
                        <div class="col-md-6 mb-2">
                           <strong>Brand:</strong> <%= product.brand %>
                        </div>
                        <% } %>
                        <% if(product.size) { %>
                        <div class="col-md-6 mb-2">
                           <strong>Size:</strong> <%= product.size %>
                        </div>
                        <% } %>
                        <% if(product.color) { %>
                        <div class="col-md-6 mb-2">
                           <strong>Color:</strong> <%= product.color %>
                        </div>
                        <% } %>
                        <% if(product.material) { %>
                        <div class="col-md-6 mb-2">
                           <strong>Material:</strong> <%= product.material %>
                        </div>
                        <% } %>
                        <% if(product.materials && product.materials.length > 0) { %>
                        <div class="col-md-6 mb-2">
                           <strong>Materials:</strong> 
                           <% product.materials.forEach(function(material, index) { %>
                              <%= material.material %><%= material.percentage ? ` (${material.percentage}%)` : '' %><%= index < product.materials.length - 1 ? ', ' : '' %>
                           <% }); %>
                        </div>
                        <% } %>
                        <% if(product.style) { %>
                        <div class="col-md-6 mb-2">
                           <strong>Style:</strong> <%= product.style %>
                        </div>
                        <% } %>
                        <% if(product.gender) { %>
                        <div class="col-md-6 mb-2">
                           <strong>Gender:</strong> <%= product.gender %>
                        </div>
                        <% } %>
                        <% if(product.season) { %>
                        <div class="col-md-6 mb-2">
                           <strong>Season:</strong> <%= product.season %>
                        </div>
                        <% } %>
                        <% if(product.seasons && product.seasons.length > 0) { %>
                        <div class="col-md-6 mb-2">
                           <strong>Seasons:</strong> <%= product.seasons.join(', ') %>
                        </div>
                        <% } %>
                     </div>
                  </div>

                  <!-- Shopee-like variant selectors -->
                  <div class="variant-group">
                     <label class="variant-label">Color</label>
                     <div id="color-options" class="variant-chips"></div>
                  </div>
                  <div class="variant-group">
                     <label class="variant-label">Size</label>
                     <div id="size-options" class="variant-chips"></div>
                  </div>

                  <div class="d-flex flex-container">
                     <form id="quantity-form" style="display:inline-block;" action="/add_cart/<%= product._id%>" method="POST" >
                        <input type="hidden" name="selected_color" id="selected_color" value="">
                        <input type="hidden" name="selected_size" id="selected_size" value="">
                     </form>
                     <div>
                        <button class="btn btn-light" style="border: 1px solid #e0dede; border-radius: 0px;"
                           onclick="addMoreCart(-1)">-</button>
                     </div>
                     <div>
                           <input type="number" name="quantity" class="form-control" step=1 value="1" style="max-width:70px; 
            border: 1px solid #e0dede; border-radius: 0px; text-align: center;" onchange="fixCartNum()">
                     </div>
                     <div>
                        <button class="btn btn-light" style="border: 1px solid #e0dede; border-radius: 0px;"
                           onclick="addMoreCart(1)">+</button>
                     </div>
                      <div>
                         <p id="variant-stock" style="margin: 8px 0px 10px 10px;"></p>
                    </div>
                  </div>
                  <button class="btn btn-success btnAdd" 
                        <% if(token != null) { %>
                        data-product-quantity="<%= product.quantity %>" onclick="handleAddToCart(this)">
                        <% } else { %>
                        onclick="checkToken()">
                        <% } %>
                     <i class="bi bi-cart4"></i> ADD TO CART
                  </button>
                  </form>
                  <% if(token != null) {%>
                     <% if(!favorite) {%>
                        <form action="/favorite/<%= product._id%>" method="POST">
                           <button class="btn btn-secondary btnAdd" onclick="Favorite()"
                           style="background: #edebeb; border: none; color: #000;">
                           <i class="bi bi-bookmark-heart-fill"></i> ADD TO LOVE
                        </button>
                        </form>
                     <%} else {%>
                        <button class="btn btn-secondary btnAdd" onclick="checkFavorite()"
                           style="background: #edebeb; border: none; color: #000;">
                           <i class="bi bi-bookmark-heart-fill"></i> ADD TO LOVE
                        </button>
                     <%}%>
                  <%}else{%>
                     <button class="btn btn-secondary btnAdd" onclick="checkToken()"
                     style="background: #edebeb; border: none; color: #000;">
                     <i class="bi bi-bookmark-heart-fill"></i> ADD TO LOVE</button>
                  <%}%>
               </div>
               <div class="col-md-12" style="margin-top: 50px;">
                  <h4>Product Description</h4>
                  <%- product.description %>
               </div>
               <div class="col-md-12">
                  <h4 style="text-align:center;">Related Products</h4>
               </div>
               <% for ( let item of productList) { %>
               <div class="col-sm-6 col-md-4 col-lg-4">
                  <div class="box">
                     <div class="option_container">
                        <div class="options">
                           <a href="/product_details/<%=item.id%>" class="option1">
                            <%= item.title%>
                           </a>
                           <form action="/add_cart/<%=item.id%>" method="POST">
                              <input type="number" name="quantity" value="1" min="1" style="width:100px;" hidden>
                              <input type="submit" value="Buy Now" class="option2" style="border-radius: 30px;">
                           </form>
                        </div>
                     </div>
                     <div class="img-box">
                        <img src="<%=item.image%>" alt="">
                     </div>
                     <div class="detail-box">
                        <h5>
                            <%=item.title%>
                        </h5>

                        <% if(item.discount_price > 0) {%>
                        <h6 style="color:red;">
                        Discount</br>
                        <%= numberFormat(item.discount_price)%>
                        </h6>
                        
                        <h6 style="text-decoration:line-through;">
                        Price</br>
                        <%= numberFormat(item.price)%>
                        </h6>
                        <% } else {%>

                        <h6>
                        Price</br>
                        <%= item.price%>
                        </h6>

                        <% } %>
                     </div>
                  </div>
               </div>
               <% } %>

            </div>
         </div>
      </section>

   </div>

   <!-- end client section -->
   <!-- comment section -->
   <%- include('comment_reply') %>
   <!-- end comment section -->
   <!-- footer start -->
   <%- include('footer') %>
   <!-- footer end -->
</body>

<script type="text/javascript">
   // Build Shopee-like variant selectors for color and size
   const ALL_COLORS = ['Black','White','Red','Blue','Green','Yellow','Pink','Purple','Orange','Brown','Gray','Navy','Beige','Cream','Multi-color','Other'];
   const ALL_SIZES = ['XS','S','M','L','XL','XXL','XXXL','One Size','Custom'];
   const defaultColor = '<%= (product.color || '').replace(/'/g, "\'") %>';
   const defaultSize = '<%= (product.size || '').replace(/'/g, "\'") %>';
   const VARIANTS = JSON.parse('<%- JSON.stringify(product.variants || []) %>');

   function renderChips(containerId, values, current, onSelect) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      values.forEach(val => {
         const chip = document.createElement('div');
         chip.className = 'variant-chip' + (val === current && current ? ' selected' : '');
         chip.textContent = val;
         chip.addEventListener('click', () => {
            // toggle selected in group
            [...container.children].forEach(c => c.classList.remove('selected'));
            chip.classList.add('selected');
            onSelect(val);
         });
         container.appendChild(chip);
      });
   }

   function setSelectedHidden(color, size) {
      if (typeof color === 'string') document.getElementById('selected_color').value = color;
      if (typeof size === 'string') document.getElementById('selected_size').value = size;
      updateVariantStock();
   }

   // If variants exist, filter options based on actual availability
   function computeAvailableColors() {
      if (!Array.isArray(VARIANTS) || VARIANTS.length === 0) return ALL_COLORS;
      const set = new Set();
      VARIANTS.filter(v => (v.quantity || 0) > 0).forEach(v => set.add(v.color));
      return Array.from(set);
   }
   function computeAvailableSizes(selectedColorVal) {
      if (!Array.isArray(VARIANTS) || VARIANTS.length === 0) return ALL_SIZES;
      const set = new Set();
      VARIANTS.filter(v => (v.quantity || 0) > 0 && (!selectedColorVal || v.color === selectedColorVal)).forEach(v => set.add(v.size));
      return Array.from(set);
   }

   function initVariantSelectors() {
      const availableColors = computeAvailableColors();
      const initialColor = availableColors.includes(defaultColor) ? defaultColor : (availableColors[0] || '');
      renderChips('color-options', availableColors, initialColor, (val) => {
         setSelectedHidden(val, undefined);
         const sizes = computeAvailableSizes(val);
         const currentSize = document.getElementById('selected_size').value;
         const initialSize = sizes.includes(currentSize) ? currentSize : (sizes[0] || '');
         renderChips('size-options', sizes.length ? sizes : ALL_SIZES, initialSize, (sv) => setSelectedHidden(undefined, sv));
         setSelectedHidden(undefined, initialSize);
      });
      const availableSizes = computeAvailableSizes(initialColor);
      const initialSize = availableSizes.includes(defaultSize) ? defaultSize : (availableSizes[0] || '');
      renderChips('size-options', availableSizes.length ? availableSizes : ALL_SIZES, initialSize, (sv) => setSelectedHidden(undefined, sv));
      setSelectedHidden(initialColor || '', initialSize || '');
   }

   initVariantSelectors();

   function updateVariantStock() {
      const stockEl = document.getElementById('variant-stock');
      if (!stockEl) return;
      const s = document.getElementById('selected_size').value;
      const c = document.getElementById('selected_color').value;
      if (Array.isArray(VARIANTS) && VARIANTS.length) {
         const v = VARIANTS.find(v => (v.size || '') === s && (v.color || '') === c);
         if (v && (v.quantity || 0) > 0) {
            stockEl.innerHTML = `<strong>Number</strong>: ${v.quantity} products`;
         } else {
            stockEl.innerHTML = '<label style="color: red; font-weight: 500;">Out of stock</label>';
         }
      } else {
         const total = <%= product.quantity %>;
         stockEl.innerHTML = (total > 0) ? `<strong>Number</strong>: ${total} products` : '<label style="color: red; font-weight: 500;">Out of stock</label>';
      }
   }
   updateVariantStock();

   function addToCart() {
      event.preventDefault();
      var quantity = document.querySelector('[name=quantity]').value;
      var selectedColor = document.getElementById('selected_color').value;
      var selectedSize = document.getElementById('selected_size').value;
      var productId = '<%= product._id %>'; // Thay th·∫ø v·ªõi ID s·∫£n ph·∫©m th·ª±c t·∫ø
      // G·ª≠i d·ªØ li·ªáu ƒë·∫øn server b·∫±ng AJAX
      var xhr = new XMLHttpRequest();
      xhr.open("POST", "/add_cart/" + productId, true);
      xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
      xhr.onreadystatechange = function() {
         if (this.readyState == 4 && this.status == 200) {
            // X·ª≠ l√Ω ph·∫£n h·ªìi t·ª´ server
            event.preventDefault();
            Swal.fire({
               title: 'Product addded successfully!',
               icon: 'success',
               confirmButtonText: 'OK'
            }).then((result) => {
               if (result.isConfirmed) {
                  window.location.reload();
               }
            });
         }
      };
      const body = `quantity=${encodeURIComponent(quantity)}&selected_color=${encodeURIComponent(selectedColor)}&selected_size=${encodeURIComponent(selectedSize)}`;
      xhr.send(body);
   }

   function addMoreCart(delta) {
      event.preventDefault(); // NgƒÉn ch·∫∑n h√†nh ƒë·ªông m·∫∑c ƒë·ªãnh
      var num = parseInt(document.querySelector('[name=quantity]').value);
      num += delta;
      if (num < 1) num = 1;
      document.querySelector('[name=quantity]').value = num;
   }


   function fixCartNum() {
      $('[name=quantity]').val(Math.abs($('[name=quantity]').val()));
   }

   function checkQuantity() {
      Swal.fire({
         title: 'Sorry Youüò≠üò≠üò≠!!!',
         text: 'The product quantity is not enough to fulfill your requirement!!!',
         icon: 'warning',
         confirmButtonText: 'OK',
      })
   }

   function handleAddToCart(button) {
    var productQuantity = parseInt(button.getAttribute('data-product-quantity'));
    var requestedQuantity = parseInt(document.querySelector('[name=quantity]').value);

      if (requestedQuantity > productQuantity) {
         // Hi·ªÉn th·ªã th√¥ng b√°o n·∫øu s·ªë l∆∞·ª£ng y√™u c·∫ßu l·ªõn h∆°n s·ªë l∆∞·ª£ng c√≥ s·∫µn
         checkQuantity();
      } else {
         // Th√™m v√†o gi·ªè h√†ng n·∫øu s·ªë l∆∞·ª£ng ƒë·ªß
         addToCart();
      }
   }

   function Favorite() {
      Swal.fire({
         title: 'Add Successfully',
         text: 'The product has been added to favorites!',
         icon: 'success',
         confirmButtonText: 'OK',
      })
   }

   function checkFavorite() {
      Swal.fire({
         title: 'Unsuccessfully',
         text: 'You have previously added this product to your favorites!',
         icon: 'warning',
         confirmButtonText: 'OK',
      })
   }

</script>

</html>